<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" href="../layui/css/layui.css" th:href="@{/layui/css/layui.css}">
    <script type="text/javascript" th:src="@{/layui/layui.js}"></script>
    <script type="text/javascript" th:src="@{/js/jquery.min.js}"></script>
</head>
<style>
    #serachDiv{
        margin-top: 10px;
        margin-left: 30%;
    }
</style>
<body>
<div id="serachDiv">
    <form class="layui-form layui-col-space5">
        <div class="layui-form-item">
<!--            在有form-item属性的div里面的lay-filter在form.render()重新渲染时使用-->
<!--            select中的lay-filter在监听动作时使用-->
            <div class="layui-input-inline">
                <select name="grade" id="grade" lay-filter="grade">
                    <option value="">请选择年级</option>
                </select>
            </div>
            <div class="layui-input-inline">
                <select name="department" id="department" lay-filter="department">
                    <option value="">请选择院系</option>
                </select>
            </div>
            <div class="layui-input-inline">
                <select name="major" id="major" lay-filter="major">
                    <option value="">请选择专业</option>
                </select>
            </div>
        </div>
        <div class="layui-form-item">
            <div class="layui-input-inline">
                <select name="clazz" id="clazz" lay-filter="clazz">
                    <option value="">请选择班级</option>
                </select>
            </div>
            <div class="layui-inline layui-show-xs-inline">
                <input type="text" name="username"  placeholder="请输入用户名字" autocomplete="off" class="layui-input">
            </div>
            <div class="layui-inline layui-show-xs-block">
                <button class="layui-btn" lay-submit="" lay-filter="searchUser"><i class="layui-icon">&#xe615;</i></button>
            </div>
        </div>
    </form>
</div>
<table class="layui-hide" id="userListTable" lay-filter="userListTable"></table>
<script type="text/html" id="toolbar">
    <a class="layui-btn layui-btn-xs" lay-event="edit">编辑</a>
    <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">删除</a>
</script>
<script th:inline="none">
    $(function () {
        // 初始化第一个下拉列表的内容
        $.ajax({
            type: 'POST',
            url: '/tableOnline/admin/getGrade',
            dataType: 'json',
            success: function (res) {
                var s = $("#grade");
                var content = "<option value=\"\">请选择年级</option>";
                $.each(res.data, function (i, val) {
                    content += "<option value=" + val.gid + ">" + val.grade + "</option>";
                });
                s.html(content);
                layui.form.render('select');
            },
            error: function (res) {
                layui.layer.msg("服务器错误");
            }
        });
    });
    layui.use(['form', 'table'], function() {
        var table = layui.table;
        var form = layui.form;

        // 生成一个表格
        var tabIns = table.render({
            elem: '#userListTable' // 表格id
            , url: '/tableOnline/admin/getUserList'
            , title: '用户列表'
            , page: true //开启分页
            , cols: [[
                {type: 'checkbox', fixed: 'left'}
                , {field: 'uid', title: 'ID', width: 80, fixed: 'left', unresize: true, sort: true}
                , {field: 'username', title: '姓名', width: 100}
                , {field: 'ulevel', title: '用户等级', width: 120}
                , {field: 'ustatus', title: '用户状态', width: 120}
                , {fixed: 'right', title: '操作', toolbar: '#toolbar', width: 150}
            ]]
        });

        // 监听年级下拉列表选择
        form.on('select(grade)', function (data) {
            $.ajax({
               type: 'POST',
               url: '/tableOnline/admin/getDepartment',
               data: {
                   gradeId: data.value
               },
                dataType: 'json',
                success: function (res) {
                    var s = $("#department");
                    var content = "<option value=\"\">请选择院系</option>";
                    $.each(res.data, function (i, val) {
                        content += "<option value=" + val.did + ">" + val.dname + "</option>";
                    });
                    s.html(content);
                    // 年级选择改变后，剩下的选项都需要清除
                    $("#major").empty().append("<option value=\"\">请选择专业</option>");
                    $("#clazz").empty().append("<option value=\"\">请选择班级</option>");
                    layui.form.render('select');
                },
                error: function (res) {
                    layui.layer.msg("服务器错误");
                }
            });
        });
        // 监听院系下拉列表选择
        form.on('select(department)', function (data) {
            $.ajax({
                type: 'POST',
                url: '/tableOnline/admin/getMajor',
                data: {
                    departmentId: data.value
                },
                dataType: 'json',
                success: function (res) {
                    var s = $("#major");
                    var content = "<option value=\"\">请选择专业</option>";
                    $.each(res.data, function (i, val) {
                        content += "<option value=" + val.mid + ">" + val.mname + "</option>";
                    });
                    s.html(content);
                    // 清除班级选项
                    $("#clazz").empty().append("<option value=\"\">请选择班级</option>");
                    layui.form.render('select');
                },
                error: function (res) {
                    layui.layer.msg("服务器错误");
                }
            });
        });

        // 监听专业下拉列表选择
        form.on('select(major)', function (data) {
            $.ajax({
                type: 'POST',
                url: '/tableOnline/admin/getClazz',
                data: {
                    majorId: data.value
                },
                dataType: 'json',
                success: function (res) {
                    var s = $("#clazz");
                    var content = "<option value=\"\">请选择班级</option>";
                    $.each(res.data, function (i, val) {
                        content += "<option value=" + val.cid + ">" + val.cnum + "</option>";
                    });
                    s.html(content);
                    layui.form.render('select');
                },
                error: function (res) {
                    layui.layer.msg("服务器错误");
                }
            });
        });

        // 搜索提交，表格重载
        form.on("submit(searchUser)", function (data) {
            console.log(data.field);
            var btn = $(this);
            btn.attr("disabled", true).addClass("layui-disabled");
            tabIns.reload({
                url: "/tableOnline/admin/searchUser",
                type: "post",
                where: data.field,
                page: {
                    cur: 1
                }
            });
            btn.attr("disabled", false).removeClass("layui-disabled");
            return false;
        });
    })
</script>

<!--表单状态模板-->
<script type="text/html" id="formStatus">
    {{# var status = d.tfflag;
    if(status === 0){
    }}
    <span>未发布</span>
    {{# }else if(status === 1) { }}
    <soan>进行中</soan>
    {{# }else if(status === 2) { }}
    <span>已结束</span>
    {{# }}}
</script>
</body>
</html>
